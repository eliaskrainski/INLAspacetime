<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="INLAspacetime">
<title>The Piemonte dataset example â€¢ INLAspacetime</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="The Piemonte dataset example">
<meta property="og:description" content="INLAspacetime">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">INLAspacetime</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <a class="dropdown-item" href="../../articles/web/barrierExample.html">Spatial models for domains with barrier</a>
    <a class="dropdown-item" href="../../articles/web/piemonte.html">Spatio-temporal examples</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/eliaskrainski/INLAspacetime/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>The Piemonte dataset example</h1>
                        <h4 data-toc-skip class="author">Elias T
Krainski</h4>
            
            <h4 data-toc-skip class="date">Started in 2022. Last update:
Tue 20 Jun, 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/eliaskrainski/INLAspacetime/blob/HEAD/vignettes/web/piemonte.Rmd" class="external-link"><code>vignettes/web/piemonte.Rmd</code></a></small>
      <div class="d-none name"><code>piemonte.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a>
</h2>
<p>In this vignette we illustrate how to fit some of the spacetime
models in <span class="citation">Lindgren et al. (2023)</span>, for the
dataset analysed in <span class="citation">Cameletti et al.
(2013)</span>. To perform this we will use the Bayesian paradigm with
the<strong>INLA</strong> package, using the features provided by the
<strong>inlabru</strong> package to facilitate the coding.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="the-packages-and-setup">The packages and setup<a class="anchor" aria-label="anchor" href="#the-packages-and-setup"></a>
</h3>
<p>We start loading the required packages and those for doing the
visualizations, the <strong>ggplot2</strong> and
<strong>patchwork</strong> packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; Loading required package: sp</span></span>
<span><span class="co">#&gt; The legacy packages maptools, rgdal, and rgeos, underpinning this package</span></span>
<span><span class="co">#&gt; will retire shortly. Please refer to R-spatial evolution reports on</span></span>
<span><span class="co">#&gt; https://r-spatial.org/r/2023/05/15/evolution4.html for details.</span></span>
<span><span class="co">#&gt; This package is now running under evolution status 0</span></span>
<span><span class="co">#&gt; This is INLA_23.06.15 built 2023-06-15 06:01:53 UTC.</span></span>
<span><span class="co">#&gt;  - See www.r-inla.org/contact-us for how to get help.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eliaskrainski/INLAspacetime" class="external-link">INLAspacetime</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.inlabru.org" class="external-link">inlabru</a></span><span class="op">)</span></span></code></pre></div>
<p>We consider the following settings for <strong>INLA</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#inla.setOption(</span></span>
<span><span class="co">#  inla.mode = "compact",</span></span>
<span><span class="co">#  num.threads = "5:-1",</span></span>
<span><span class="co">#  smtp = "pardiso",</span></span>
<span><span class="co">#  pardiso.license = "~/.pardiso.lic"</span></span>
<span><span class="co">#)</span></span></code></pre></div>
<p>We will ask it to return the WAIC, DIC and CPO</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctrc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  waic <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  dic <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cpo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="getting-the-dataset">Getting the dataset<a class="anchor" aria-label="anchor" href="#getting-the-dataset"></a>
</h3>
<p>We will use the dataset analysed in <span class="citation">Cameletti
et al. (2013)</span>, that can be downloaded as follows. First, we set
the filenames</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"http://inla.r-inla-download.org/"</span>,</span>
<span>    <span class="st">"r-inla.org/case-studies/Cameletti2012/"</span><span class="op">)</span></span>
<span><span class="va">coofl</span> <span class="op">&lt;-</span> <span class="st">"coordinates.csv"</span></span>
<span><span class="va">datafl</span> <span class="op">&lt;-</span> <span class="st">"Piemonte_data_byday.csv"</span></span>
<span><span class="va">bordersfl</span> <span class="op">&lt;-</span> <span class="st">"Piemonte_borders.csv"</span></span></code></pre></div>
<p>Download and read the borders file</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### get the domain borders</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">bordersfl</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">u0</span>, <span class="va">bordersfl</span><span class="op">)</span>, <span class="va">bordersfl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pborders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">bordersfl</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 27821     2</span></span></code></pre></div>
<p>Download and read the coordinates file</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### get the coordinates</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">coofl</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">u0</span>, <span class="va">coofl</span><span class="op">)</span>, <span class="va">coofl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">coofl</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 24  3</span></span></code></pre></div>
<p>Download and read the dataset</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### get the dataset</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">datafl</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">u0</span>, <span class="va">datafl</span><span class="op">)</span>, <span class="va">datafl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">pdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">datafl</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4368   11</span></span></code></pre></div>
<p>Inspect the dataset</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Station.ID     Date     A   UTMX    UTMY   WS   TEMP   HMIX PREC   EMI PM10</span></span>
<span><span class="co">#&gt; 1          1 01/10/05  95.2 469.45 4972.85 0.90 288.81 1294.6    0 26.05   28</span></span>
<span><span class="co">#&gt; 2          2 01/10/05 164.1 423.48 4950.69 0.82 288.67 1139.8    0 18.74   22</span></span>
<span><span class="co">#&gt; 3          3 01/10/05 242.9 490.71 4948.86 0.96 287.44 1404.0    0  6.28   17</span></span>
<span><span class="co">#&gt; 4          4 01/10/05 149.9 437.36 4973.34 1.17 288.63 1042.4    0 29.35   25</span></span>
<span><span class="co">#&gt; 5          5 01/10/05 405.0 426.44 5045.66 0.60 287.63 1038.7    0 32.19   20</span></span>
<span><span class="co">#&gt; 6          6 01/10/05 257.5 394.60 5001.18 1.02 288.59 1048.3    0 34.24   41</span></span></code></pre></div>
<p>Prepare the time to be used</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">$</span><span class="va">Date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">$</span><span class="va">Date</span>, <span class="st">"%d/%m/%y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2005-10-01" "2006-03-31"</span></span>
<span><span class="va">pdata</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span></span>
<span>    <span class="va">pdata</span><span class="op">$</span><span class="va">Date</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span></code></pre></div>
<p>Standardize the covariates that will be used in the data analysis and
define a dataset including the needed information where the outcome is
the log of <code>PM10</code>, as used in <span class="citation">Cameletti et al. (2013)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### prepare the covariates</span></span>
<span><span class="va">xnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"WS"</span>, <span class="st">"TEMP"</span>, <span class="st">"HMIX"</span>, <span class="st">"PREC"</span>, <span class="st">"EMI"</span><span class="op">)</span></span>
<span><span class="va">xmean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">[</span>, <span class="va">xnames</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">xsd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">[</span><span class="va">xnames</span><span class="op">]</span>, <span class="va">sd</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### prepare the data (st loc, scale covariates and log PM10)</span></span>
<span><span class="va">dataf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UTMX"</span>, <span class="st">"UTMY"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">[</span><span class="va">xnames</span><span class="op">]</span>, <span class="va">xmean</span>, <span class="va">xsd</span><span class="op">)</span>,</span>
<span>                    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">$</span><span class="va">PM10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">dataf</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    4368 obs. of  10 variables:</span></span>
<span><span class="co">#&gt;  $ UTMX: num  469 423 491 437 426 ...</span></span>
<span><span class="co">#&gt;  $ UTMY: num  4973 4951 4949 4973 5046 ...</span></span>
<span><span class="co">#&gt;  $ time: num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ A   : num  -1.3956 -0.7564 -0.0254 -0.8881 1.4785 ...</span></span>
<span><span class="co">#&gt;  $ WS  : num  -0.0777 -0.2319 0.038 0.4429 -0.6561 ...</span></span>
<span><span class="co">#&gt;  $ TEMP: num  2.1 2.07 1.82 2.06 1.86 ...</span></span>
<span><span class="co">#&gt;  $ HMIX: num  2.18 1.69 2.53 1.38 1.37 ...</span></span>
<span><span class="co">#&gt;  $ PREC: num  -0.29 -0.29 -0.29 -0.29 -0.29 ...</span></span>
<span><span class="co">#&gt;  $ EMI : num  -0.1753 -0.3454 -0.6353 -0.0985 -0.0324 ...</span></span>
<span><span class="co">#&gt;  $ y   : num  3.33 3.09 2.83 3.22 3 ...</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="the-data-model-definition">The data model definition<a class="anchor" aria-label="anchor" href="#the-data-model-definition"></a>
</h2>
<p>We consider the following linear mixed model for the outcome <span class="math display">\[
\mathbf{y} = \mathbf{W}\mathbf{\beta} + \mathbf{A}\mathbf{u} +
\mathbf{e}
\]</span> where <span class="math inline">\(\beta\)</span> are fixed
effects, or regression coefficients including the intercept, for the
matrix of covariates <span class="math inline">\(\mathbf{W}\)</span>,
<span class="math inline">\(\mathbf{u}\)</span> is the spatio-temporal
random effect having the matrix <span class="math inline">\(\mathbf{A}\)</span> the projector matrix from the
discretized domain to the data. The spatio-temporal random effect <span class="math inline">\(\mathbf{u}\)</span> is defined in a continuous
spacetime domain being discretized considering meshes over time and
space. The difference from <span class="citation">Cameletti et al.
(2013)</span> is that we now use the models in <span class="citation">Lindgren et al. (2023)</span> for <span class="math inline">\(\mathbf{u}\)</span>.</p>
<p>Define a temporal mesh, with each knot spaced by <code>h</code>,
where <code>h = 1</code> means one per day.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pdata</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">tmesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.1d.html" class="external-link">inla.mesh.1d</a></span><span class="op">(</span></span>
<span>  loc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nt</span> <span class="op">+</span> <span class="va">h</span><span class="op">/</span><span class="fl">2</span>, <span class="va">h</span><span class="op">)</span>, </span>
<span>  degree <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">tmesh</span><span class="op">$</span><span class="va">n</span></span>
<span><span class="co">#&gt; [1] 182</span></span></code></pre></div>
<p>Define a spatial mesh, the same used in <span class="citation">Cameletti et al. (2013)</span>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html" class="external-link">inla.mesh.2d</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">locs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">locs</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    loc.domain <span class="op">=</span> <span class="va">pborders</span>,</span>
<span>    max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">300</span><span class="op">)</span>,</span>
<span>    offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">140</span><span class="op">)</span>,</span>
<span>    cutoff <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    min.angle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">26</span>, <span class="fl">21</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">smesh</span><span class="op">$</span><span class="va">n</span></span>
<span><span class="co">#&gt; [1] 142</span></span></code></pre></div>
<p>Visualize the spatial mesh, the border and the locations.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">smesh</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">pborders</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"green4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">locs</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="piemonte_files/figure-html/smeshvis-1.png" width="672"></p>
<p>We set the prior for the likelihood precision considering a PC-prior,
<span class="citation">Simpson et al. (2017)</span>, through the
following probabilistic statements: P(<span class="math inline">\(\sigma_e &gt; U_{\sigma_e}\)</span>) = <span class="math inline">\(\alpha_{\sigma_e}\)</span>, using <span class="math inline">\(U_{\sigma_e}\)</span> = 1 and <span class="math inline">\(\alpha_{\sigma_e} = 0.05\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lkprec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"pcprec"</span>, param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With <strong>inlabru</strong> we can define the likelihood model with
the <code><a href="https://inlabru-org.github.io/inlabru/reference/like.html" class="external-link">like()</a></code> function and use it for fitting models with
different linear predictors later.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lhood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/like.html" class="external-link">like</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>  control.family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    hyper <span class="op">=</span> <span class="va">lkprec</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dataf</span><span class="op">)</span></span></code></pre></div>
<p>The linear predictor, the right-rand side of the formula, can be
defined using the same expression for of the both models that we are
going to fit and is</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu">Intercept</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="va">A</span> <span class="op">+</span> <span class="va">WS</span> <span class="op">+</span> <span class="va">TEMP</span> <span class="op">+</span> <span class="va">HMIX</span> <span class="op">+</span> <span class="va">PREC</span> <span class="op">+</span> <span class="va">EMI</span> <span class="op">+</span></span>
<span>    <span class="fu">field</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">UTMX</span>, <span class="va">UTMY</span><span class="op">)</span>, </span>
<span>               time <span class="op">=</span> <span class="va">time</span><span class="op">)</span>,</span>
<span>          model <span class="op">=</span> <span class="va">stmodel</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-spacetime-models">The spacetime models<a class="anchor" aria-label="anchor" href="#the-spacetime-models"></a>
</h2>
<p>The implementation of the spacetime model uses the
<code>cgeneric</code> interface in <strong>INLA</strong>, see its
documentation for details. Therefore we have a <code>C</code> code to
mainly build the precision matrix and compute the model parameter priors
and compiled as static library. We have this code included in the
<strong>INLAspacetime</strong> package but it is also being copied to
the <strong>INLA</strong> package and compiled with the same compilers
in order to avoid possible mismatches. In order to use it, we have to
define the matrices and vectors needed, including the prior parameter
definitions.</p>
<p>The class of models in <span class="citation">Lindgren et al.
(2023)</span> have the spatial range, temporal range and marginal
standard deviation as parameters. We consider the PC-prior, as in <span class="citation">Fuglstad et al. (2017)</span>, for these parameters
defined from the probability statements: P(<span class="math inline">\(r_s&lt;U_{r_s}\)</span>)=<span class="math inline">\(\alpha_{r_s}\)</span>, P(<span class="math inline">\(r_t&lt;U_{r_t}\)</span>)=<span class="math inline">\(\alpha_{r_t}\)</span> and P(<span class="math inline">\(\sigma&lt;U_{\sigma}\)</span>)=<span class="math inline">\(\alpha_{\sigma}\)</span>. We consider <span class="math inline">\(U_{r_s}=100\)</span>, <span class="math inline">\(U_{r_t}=5\)</span> and <span class="math inline">\(U_{\sigma}=2\)</span>. <span class="math inline">\(\alpha_{r_s}=\alpha_{r_t}=\alpha_{\sigma}=0.05\)</span></p>
<p>The selection of one of the models in <span class="citation">Lindgren
et al. (2023)</span> is by chosing the <span class="math inline">\(\alpha_t\)</span>, <span class="math inline">\(\alpha_s\)</span> and <span class="math inline">\(\alpha_e\)</span> as integer numbers. We will
start considering the model <span class="math inline">\(\alpha_t=1\)</span>, <span class="math inline">\(\alpha_s=0\)</span> and <span class="math inline">\(\alpha_t=2\)</span>, which is a model with
separable spatio-temporal covariance, and then we fit some of the other
models later.</p>
<div class="section level3">
<h3 id="defining-a-particular-model">Defining a particular model<a class="anchor" aria-label="anchor" href="#defining-a-particular-model"></a>
</h3>
<p>We define an object with the needed use the function
<code><a href="../../reference/stModel.define.html">stModel.define()</a></code> where the model is selected considering
the values for <span class="math inline">\(\alpha_t\)</span>, <span class="math inline">\(\alpha_s\)</span> and <span class="math inline">\(\alpha_e\)</span> collapsed. In order to
illustrate how it is done, we can set an overall integrate-to-zero
constraint, which is not need but helps model components identification.
It uses the weights based on the mesh node volumes, from both the
temporal and spatial meshes. This can be set automatically when defining
the model by adding <code>constr = TRUE</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"102"</span></span>
<span><span class="va">stmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/stModel.define.html">stModel.define</a></span><span class="op">(</span></span>
<span>    <span class="va">smesh</span>, <span class="va">tmesh</span>, <span class="va">model</span>,</span>
<span>    control.priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        prs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>        prt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>        psigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    constr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Initial values for the hyper-parameters help to fit the models in
less computing time. It is also important to consider in the light that
each dataset has its own parameter scale. For example, we have to
consider that the spatial domain within a box of around <span class="math inline">\(203.7\)</span> by <span class="math inline">\(266.5\)</span> kilometers, which we already did
when building the mesh and setting the prior for or <span class="math inline">\(r_s\)</span>.</p>
<p>We can set initial values for the log of the parameters so that it
would take less iterations to converge:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta.ini</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">7</span>, <span class="fl">7</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>The code to fit the model through <strong>inlabru</strong> is</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit102</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span><span class="va">M</span>,</span>
<span>        <span class="va">lhood</span>,</span>
<span>        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            control.mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta.ini</span>, restart <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            control.compute <span class="op">=</span> <span class="va">ctrc</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The computing time is</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit102</span><span class="op">$</span><span class="va">cpu</span></span>
<span><span class="co">#&gt;        Pre    Running       Post      Total </span></span>
<span><span class="co">#&gt;   1.082259 944.715038   5.392718 951.190014</span></span></code></pre></div>
<p>Summary of the posterior marginal distributions for the fixed
effects</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit102</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;                  mean          sd   0.025quant   0.975quant</span></span>
<span><span class="co">#&gt; Intercept  3.73744098 0.241853786  3.260123896  4.214248405</span></span>
<span><span class="co">#&gt; A         -0.17895115 0.049278366 -0.276630473 -0.082390236</span></span>
<span><span class="co">#&gt; WS        -0.06034311 0.008446065 -0.076895057 -0.043769398</span></span>
<span><span class="co">#&gt; TEMP      -0.12181538 0.035192078 -0.190897179 -0.052872676</span></span>
<span><span class="co">#&gt; HMIX      -0.02384308 0.013208896 -0.049706440  0.002099424</span></span>
<span><span class="co">#&gt; PREC      -0.05356068 0.008605912 -0.070421584 -0.036668615</span></span>
<span><span class="co">#&gt; EMI        0.03659603 0.015079616  0.006666037  0.065890294</span></span></code></pre></div>
<p>For the hyperparameters, we transform the posterior marginal
distributions for the model hyperparameters from the ones computed in
internal scale, <span class="math inline">\(\log(1/\sigma^2_e)\)</span>,
<span class="math inline">\(\log(r_s)\)</span>, <span class="math inline">\(\log(r_t)\)</span> and <span class="math inline">\(\log(\sigma)\)</span>, to the user scale
parametrization, <span class="math inline">\(\sigma_e\)</span>, <span class="math inline">\(r_s\)</span>, <span class="math inline">\(r_t\)</span> and <span class="math inline">\(\sigma\)</span>, respectivelly.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post.h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sigma_e <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, </span>
<span>                           <span class="va">fit102</span><span class="op">$</span><span class="va">internal.marginals.hyperpar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  range_s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, </span>
<span>                           <span class="va">fit102</span><span class="op">$</span><span class="va">internal.marginals.hyperpar</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  range_t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, </span>
<span>                           <span class="va">fit102</span><span class="op">$</span><span class="va">internal.marginals.hyperpar</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  sigma_u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, </span>
<span>                           <span class="va">fit102</span><span class="op">$</span><span class="va">internal.marginals.hyperpar</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we compute and show the summary of it</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shyper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">post.h</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.zmarginal</a></span><span class="op">(</span><span class="va">m</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">shyper</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;                mean           sd  quant0.025  quant0.975</span></span>
<span><span class="co">#&gt; sigma_e   0.1806347  0.003793794   0.1733157   0.1882151</span></span>
<span><span class="co">#&gt; range_s 277.8478053 17.052628017 246.0378467 312.9909265</span></span>
<span><span class="co">#&gt; range_t  48.5655929  7.871462230  35.1795048  66.0248683</span></span>
<span><span class="co">#&gt; sigma_u   1.1230248  0.085661291   0.9666323   1.3028629</span></span></code></pre></div>
<p>However, it is better to look at the posterior marginal itself, and
we will visualize it later.</p>
<p>The model fitted in <span class="citation">Cameletti et al.
(2013)</span> includes two more covariates and setup a model for
discrete temporal domain where the temporal correlation is modeled as a
first order autoregression with parameter <span class="math inline">\(\rho\)</span>. In the fitted model here is defined
considering continuous temporal domain with the range parameter <span class="math inline">\(r_s\)</span>. However, the first order
autocorrelation could be taken as <span class="math inline">\(\rho =
\exp(-h\sqrt{8\nu}/r_s)\)</span>, where <span class="math inline">\(h\)</span> is the temporal resolution used in the
temporal mesh and <span class="math inline">\(\nu\)</span> is equal
<span class="math inline">\(0.5\)</span> for the fitted model. We can
compare ou results with Table 3 in <span class="citation">Cameletti et
al. (2013)</span> with</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">shyper</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">]</span>, </span>
<span>  a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">h</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">8</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="va">shyper</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     sigma_e     sigma_u     range_s           a </span></span>
<span><span class="co">#&gt;   0.1806347   1.1230248 277.8478053   0.9596550</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-different-models">Comparing different models<a class="anchor" aria-label="anchor" href="#comparing-different-models"></a>
</h2>
<p>We now fit the model <span class="math inline">\(121\)</span> for
<span class="math inline">\(u\)</span> as well, we use the same code for
building the model matrices</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"121"</span></span>
<span><span class="va">stmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/stModel.define.html">stModel.define</a></span><span class="op">(</span></span>
<span>    <span class="va">smesh</span>, <span class="va">tmesh</span>, <span class="va">model</span>,</span>
<span>    control.priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        prs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>        prt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>        psigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    constr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>and use the same code for fitting as follows</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit121</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/bru.html" class="external-link">bru</a></span><span class="op">(</span><span class="va">M</span>,</span>
<span>        <span class="va">lhood</span>,</span>
<span>        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            control.mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta.ini</span>, restart <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            control.compute <span class="op">=</span> <span class="va">ctrc</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will join these fits into a list object to make it easier working
with it</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"u102"</span> <span class="op">=</span> <span class="va">fit102</span>, <span class="st">"u121"</span> <span class="op">=</span> <span class="va">fit121</span><span class="op">)</span></span></code></pre></div>
<p>The computing time for each model fit</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span><span class="op">$</span><span class="va">cpu</span><span class="op">)</span></span>
<span><span class="co">#&gt;               u102         u121</span></span>
<span><span class="co">#&gt; Pre       1.082259    0.7484939</span></span>
<span><span class="co">#&gt; Running 944.715038 3167.6352224</span></span>
<span><span class="co">#&gt; Post      5.392718    3.3944588</span></span>
<span><span class="co">#&gt; Total   951.190014 3171.7781751</span></span></code></pre></div>
<p>and the number of fn-calls during the optimization are</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span><span class="op">$</span><span class="va">misc</span><span class="op">$</span><span class="va">nfunc</span><span class="op">)</span></span>
<span><span class="co">#&gt; u102 u121 </span></span>
<span><span class="co">#&gt;  304  426</span></span></code></pre></div>
<p>The posterior mode for each parameter in each model (in internal
scale) are</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span><span class="op">$</span><span class="va">mode</span><span class="op">$</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                                  u102      u121</span></span>
<span><span class="co">#&gt; Log precision for the Gaussian observations 3.4235133  3.594553</span></span>
<span><span class="co">#&gt; Theta1 for field                            5.6237032  7.289114</span></span>
<span><span class="co">#&gt; Theta2 for field                            3.8588522 10.974946</span></span>
<span><span class="co">#&gt; Theta3 for field                            0.1084578  2.152672</span></span></code></pre></div>
<p>We compute the posterior marginal distribution for the
hyper-parameters in the user-interpretable scale, like we did before for
the first model, with</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posts.h2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">posts.h2</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sigma_e</span> <span class="op">=</span>  </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>        parameter <span class="op">=</span> <span class="st">"sigma_e"</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.tmarginal</a></span><span class="op">(</span></span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, </span>
<span>          <span class="va">results</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">internal.marginals.hyperpar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">posts.h2</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">p</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>   </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>        parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"range_s"</span>, <span class="st">"range_t"</span>, <span class="st">"sigma_u"</span><span class="op">)</span><span class="op">[</span><span class="va">p</span><span class="op">]</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html" class="external-link">inla.tmarginal</a></span><span class="op">(</span></span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, </span>
<span>          <span class="va">results</span><span class="op">[[</span><span class="va">m</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">internal.marginals.hyperpar</span><span class="op">[[</span><span class="va">p</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Join these all to make visualization easier</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posts.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"102"</span>, <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">posts.h2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"121"</span>, <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">posts.h2</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">posts.df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">model</span>, color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="piemonte_files/figure-html/hpmds2-1.png" width="672"></p>
<p>The comparison of the model parameters of <span class="math inline">\(\mathbf{u}\)</span> for different models have to
be done in light with the covariance functions as illustrated in <span class="citation">Lindgren et al. (2023)</span>. The fitted <span class="math inline">\(\sigma_e\)</span> by the different models are
comparable and we can see that when considering model <span class="math inline">\(121\)</span> for <span class="math inline">\(\mathbf{u}\)</span>, its posterior marginal are
concentrated in values lower than when considering model <span class="math inline">\(102\)</span>.</p>
<p>We can look at the posterior mean of <span class="math inline">\(u\)</span> from both models and see that under
model â€˜121â€™ there is a wider spread.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">0.0</span><span class="op">)</span>, mgp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">uu.hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">field</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>         <span class="op">-</span><span class="fl">60</span><span class="op">:</span><span class="fl">60</span><span class="op">/</span><span class="fl">20</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ylm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">uu.hist</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">count</span>, <span class="va">uu.hist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">count</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">uu.hist</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="va">ylm</span>,</span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">1.0</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"u"</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">uu.hist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"separable"</span>, <span class="st">"non-separable"</span><span class="op">)</span>, </span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.1</span><span class="op">)</span>, <span class="fl">0.1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>, </span>
<span>       border <span class="op">=</span> <span class="st">'transparent'</span>, bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="piemonte_files/figure-html/uhist-1.png" width="672"></p>
<p>We can also check fitting statistics such as DIC, WAIC, the negative
of the log of the probability ordinates (LPO) and its cross-validated
version (LCPO), summarized as the mean.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>DIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">local.dic</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    WAIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">local.waic</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    LPO <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">po</span><span class="op">$</span><span class="va">po</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    LCPO <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">cpo</span><span class="op">$</span><span class="va">cpo</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             DIC       WAIC        LPO       LCPO</span></span>
<span><span class="co">#&gt; u102 -0.3787469 -0.2614016 -0.4078399 -0.1139939</span></span>
<span><span class="co">#&gt; u121 -0.4113521 -0.3164072 -0.5085325 -0.1099647</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-automatic-group-leave-out-cross-validation">The automatic group-leave-out cross validation<a class="anchor" aria-label="anchor" href="#the-automatic-group-leave-out-cross-validation"></a>
</h2>
<p>One may be interested in evaluating the model prediction. The
leave-one-out strategy was already available in <strong>INLA</strong>
since several years ago, see <span class="citation">Held, Schrodle, and
Rue (2010)</span> for details. Recently, an automatic group cross
validation strategy was implemented, see <span class="citation">Liu and
Rue (2023)</span> for details.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g5cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">results</span>, <span class="va">inla.group.cv</span>, num.level.sets <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  strategy <span class="op">=</span> <span class="st">"posterior"</span>, size.max <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>We can inspect the detected observations that have the posterior
linear predictor correlated with each one, including itself. For 100th
observation under model â€œ102â€ we have</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g5cv</span><span class="op">$</span><span class="va">u102</span><span class="op">$</span><span class="va">group</span><span class="op">[[</span><span class="fl">100</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; $idx</span></span>
<span><span class="co">#&gt; [1]  52  76  98 100 106 124</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $corr</span></span>
<span><span class="co">#&gt; [1] 0.2550140 0.4275774 0.2989975 1.0000000 0.3286188 0.4275774</span></span></code></pre></div>
<p>and for the result under model â€œ121â€ we have</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g5cv</span><span class="op">$</span><span class="va">u121</span><span class="op">$</span><span class="va">group</span><span class="op">[[</span><span class="fl">100</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; $idx</span></span>
<span><span class="co">#&gt; [1]  52  76  98 100 124 148</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $corr</span></span>
<span><span class="co">#&gt; [1] 0.1668915 0.3732088 0.1668915 1.0000000 0.3756488 0.1637220</span></span></code></pre></div>
<p>which has intersection but are not the same, for the model setup
used.</p>
<p>We can check which are these observations in the dataset</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataf</span><span class="op">[</span><span class="va">g5cv</span><span class="op">$</span><span class="va">u102</span><span class="op">$</span><span class="va">group</span><span class="op">[[</span><span class="fl">100</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">idx</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;       UTMX    UTMY time          A           WS     TEMP       HMIX       PREC</span></span>
<span><span class="co">#&gt; 52  437.36 4973.34    3 -0.8881265  0.982687762 1.077344 -0.6959771 1.94505331</span></span>
<span><span class="co">#&gt; 76  437.36 4973.34    4 -0.8881265  0.674216318 1.297701  0.9479287 3.70037355</span></span>
<span><span class="co">#&gt; 98  423.48 4950.69    5 -0.7563919 -0.578948923 1.387847 -0.4413098 0.08590275</span></span>
<span><span class="co">#&gt; 100 437.36 4973.34    5 -0.8881265  0.770613644 1.441935  0.2530248 0.16426526</span></span>
<span><span class="co">#&gt; 106 416.65 4985.65    5  0.3225334 -0.000564966 1.397863  1.1608209 0.63052220</span></span>
<span><span class="co">#&gt; 124 437.36 4973.34    6 -0.8881265  0.751334179 1.618220  1.0845756 0.03692618</span></span>
<span><span class="co">#&gt;             EMI        y</span></span>
<span><span class="co">#&gt; 52  -0.01821338 2.564949</span></span>
<span><span class="co">#&gt; 76  -0.01542101 2.708050</span></span>
<span><span class="co">#&gt; 98  -0.27115486 2.484907</span></span>
<span><span class="co">#&gt; 100  0.01622576 2.890372</span></span>
<span><span class="co">#&gt; 106 -0.61950205 2.708050</span></span>
<span><span class="co">#&gt; 124  0.02599903 2.995732</span></span></code></pre></div>
<p>and found that most are at the same locations in nearby time.</p>
<p>We can compute the negative of the mean of the log score so that
lower number is better</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">g5cv</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">cv</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       u102       u121 </span></span>
<span><span class="co">#&gt; 0.04089489 0.06964227</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-cameletti2013" class="csl-entry">
Cameletti, Michela, Finn Lindgren, Daniel Simpson, and HÃ¥vard Rue. 2013.
<span>â€œSpatio-Temporal Modeling of Particulate Matter Concentration
Through the SPDE Approach.â€</span> <em>AStA Advances in Statistical
Analysis</em> 97 (2): 109â€“31. <a href="https://doi.org/10.1007/s10182-012-0196-3" class="external-link">https://doi.org/10.1007/s10182-012-0196-3</a>.
</div>
<div id="ref-fuglstad2015pcmatern" class="csl-entry">
Fuglstad, Geir-Arne, Daniel Simpson, Finn Lindgren, and HÃ¥vard Rue.
2017. <span>â€œConstructing Priors That Penalize the Complexity of
<span>G</span>aussian Random Fields.â€</span> <em>Journal of the American
Statistical Association</em>, no. 525: 445â€“52.
</div>
<div id="ref-Heldetal2010cpo" class="csl-entry">
Held, Leonhard, Birgit Schrodle, and HÃ¥vard Rue. 2010. <span>â€œ<span class="nocase">Posterior and Cross-validatory Predictive Checks: A
Comparison of MCMC and INLA</span>.â€</span> In <em>Statistical Modelling
and Regression Structures</em>, 111â€“31. Springer.
</div>
<div id="ref-lindgren2023" class="csl-entry">
Lindgren, F., H. Bakka, D. Bolin, E. Krainski, and H. Rue. 2023.
<span>â€œA Diffusion-Based Spatio-Temporal Extension of Gaussian MatÃ©rn
Fields.â€</span> <em>ArXiv</em>. <a href="https://arxiv.org/abs/2006.04917" class="external-link">https://arxiv.org/abs/2006.04917</a>.
</div>
<div id="ref-zhedongH2023gcpo" class="csl-entry">
Liu, Z., and H. Rue. 2023. <span>â€œLeave-Group-Out Cross-Validation for
Latent <span>G</span>aussian Models.â€</span> <a href="https://arxiv.org/abs/2210.04482" class="external-link">https://arxiv.org/abs/2210.04482</a>.
</div>
<div id="ref-simpson2017pcprior" class="csl-entry">
Simpson, Daniel, HÃ¥vard Rue, Andrea Riebler, Thiago G Martins, and
Sigrunn H SÃ¸rbye. 2017. <span>â€œPenalising Model Component Complexity: A
Principled, Practical Approach to Constructing Priors.â€</span>
<em>Statistical Science</em> 32 (1): 1â€“28.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Elias Teixeira Krainski, Finn Lindgren, Haavard Rue.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
